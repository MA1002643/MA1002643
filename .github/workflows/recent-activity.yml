name: Update recent activity

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes

permissions:
  contents: write

concurrency:
  group: recent-activity
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      # The action expects this env var, not an input
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Reads .github/recent-activity.config.yml and updates README
      - name: Update README with recent activity
        uses: Readme-Workflows/recent-activity@v2.4.1
        # Do not pass inputs; it reads your config file and env.GITHUB_TOKEN

      # Keep the "Last Updated" line fresh even if there are no new events
      - name: Force-refresh "Last Updated" line
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs'); // 'core' is provided by github-script; don't re-require it.

            const README = './README.md';
            const START = '<!--RECENT_ACTIVITY:last_update-->';
            const END   = '<!--RECENT_ACTIVITY:last_update_end-->';

            const ordinal = (n) => {
              const s = ['th','st','nd','rd'], v = n % 100;
              return n + (s[(v - 20) % 10] || s[v] || s[0]);
            };

            const tz = 'Europe/London';
            const parts = new Intl.DateTimeFormat('en-GB', {
              timeZone: tz,
              weekday: 'long',
              month: 'long',
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              second: '2-digit',
              hour12: true
            }).formatToParts(new Date()).reduce((acc, p) => (acc[p.type] = p.value, acc), {});
            const dayNum = parseInt(parts.day, 10);
            const line = `Last Updated: ${parts.weekday}, ${parts.month} ${ordinal(dayNum)}, ${parts.year}, ${parts.hour}:${parts.minute}:${parts.second} ${parts.dayPeriod}`;

            let md = fs.readFileSync(README, 'utf8');
            const blockRE = new RegExp(`${START}[\\s\\S]*?${END}`, 'm');
            if (!blockRE.test(md)) {
              core.setFailed('Markers not found: RECENT_ACTIVITY:last_update / _end');
            } else {
              md = md.replace(blockRE, `${START}\n${line}\n${END}`);
              fs.writeFileSync(README, md, 'utf8');
              core.notice(line);
            }

      - name: Commit timestamp bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: bump recent-activity timestamp"
          file_pattern: README.md
